---
title: "R Notebook"
output: html_notebook
---

```{r}
rm(list = ls())
library(dplyr)
library(xgboost)

# 载入工件
# artifacts <- readRDS("output/modeling.rds")
artifacts <- readRDS("output/modeling_2.rds")
class_levels <- artifacts$class_levels
levels_list <- artifacts$levels_list
```

```{r}
# 统一预处理：把用户输入映射到训练时的特征矩阵
prepare_matrix <- function(df_user_numeric){
  # 这里假设你在 Shiny 端已经把输入整理成与训练一致的数据框，并完成了 factor->numeric 的处理
  mat <- as.matrix(df_user_numeric[, artifacts$features, drop = FALSE])
  xgb.DMatrix(data = mat)
}

# 模型加载（Shiny的server启动时加载一次就好）
mdl <- xgb.load("model_final.xgb")

# 预测函数（输出：全类概率 + top-k）
predict_party <- function(df_user_numeric, top_k = 3){
  dnew <- prepare_matrix(df_user_numeric)
  prob <- predict(mdl, newdata = dnew)
  prob_mat <- matrix(prob, ncol = artifacts$n_class, byrow = TRUE)

  # top-k
  ord <- t(apply(prob_mat, 1, order, decreasing = TRUE))
  top <- lapply(seq_len(nrow(prob_mat)), function(i){
    idx <- ord[i, 1:top_k]
    data.frame(
      party = class_levels[idx],
      prob  = prob_mat[i, idx],
      stringsAsFactors = FALSE
    )
  })

  list(probs = prob_mat, topk = top)
}
```

#### 1

```{r}
library(shiny)
library(shinythemes)
library(xgboost)
library(ggplot2)

choices_agree <- c(
  "Strongly disagree", 
  "Somewhat disagree", 
  "Neither agree nor disagree", 
  "Somewhat agree", 
  "Strongly agree"
)

choices_yes_no <- c(
  "Yes", "No"
)

choices_province <- c(
  "Alberta","British Columbia","Manitoba","New Brunswick","Newfoundland and Labrador",
  "Northwest Territories","Nova Scotia","Nunavut","Ontario","Prince Edward Island",
  "Quebec","Saskatchewan","Yukon"
)

age_input <- sliderInput(
  inputId = "q1",
  label = "Your age (in years):",
  min = 18,
  max = 100,
  value = 30
)

question_texts <- c(
  "Were you born in Canada?",
  "In which province or territory are you currently living?",
  "Are you presently married, living with a partner, divorced, separated, widowed, or have you never been married?",
  "The government does not care much about what people like me think.",
  "How satisfied are you with the performance of the federal government under Justin Trudeau?",
  "We have gone too far in pushing equal rights in this country.",
  "How much do you think should be done for racial minorities?",
  "Should abortion be banned?",
  "This country would have many fewer problems if there was more emphasis on traditional family values.",
  "We have gone too far in pushing bilingualism in Canada.",
  "Newer lifestyles are contributing to the breakdown of our society.",
  "Too many recent immigrants just don't want to fit in to Canadian society.",
  "Immigrants take jobs away from other Canadians.",
  "Is income inequality a big problem in Canada?",
  "The government should leave it entirely to the private sector to create jobs.",
  "When there is a conflict between protecting the environment and creating jobs, jobs should come first."
)

choices_list <- list(
  choices_yes_no,
  choices_province,
  c("Married", "Living with a partner", "Divorced", "Separated", "Widowed", "Never Married"),
  choices_agree,
  c("Very satisfied", "Fairly satisfied", "Not very satisfied", "Not at all satisfied"),
  choices_agree,
  c("Much more", "Somewhat more", "About the same as now", "Somewhat less", "Much less"),
  c("Yes", "In some circumstances", "No"),
  choices_agree,
  choices_agree,
  choices_agree,
  choices_agree,
  choices_agree,
  c("Definitely yes", "Probably yes", "Not sure", "Probably not", "Definitely not"),
  choices_agree,
  choices_agree
)

input_list <- lapply(seq_along(question_texts), function(i) {
  selectInput(
    inputId = paste0("q", i + 1),  # q2 ~ q17
    label = question_texts[i],
    choices = choices_list[[i]]
  )
})

# 合并所有控件为一个 tagList（用于 UI 显示）
all_inputs <- c(list(age_input), input_list)

```

```{r}
artifacts <- readRDS("output/modeling_2.rds")


ui <- fluidPage(
  titlePanel("Voter Preference Prediction"),
  
  tabsetPanel(id = "mainTabs",
    tabPanel("Form",
      sidebarLayout(
        sidebarPanel(
          h4("Project description"),
          p("This project predicts the likelihood of a voter supporting each Canadian political party based on their responses to 16 questions. Select your answers below and click Predict to see probabilities.")
        ),
        
        mainPanel(
          do.call(tagList, all_inputs),      # 所有输入项
          actionButton("goButton", "Predict"),  # 点击后触发预测
          #br(), br(),
          #tableOutput("pred")               # 预测结果表格
        )
      )
    ),
    
    tabPanel("Results",
      
      sidebarLayout(
        sidebarPanel(
      h3("Prediction Results"),
      tableOutput("pred"),  # 显示结果
        ),
        
        mainPanel(
      plotOutput("predPlot", height = "400px")
    )))
  )
)


server <- function(input, output, session) {
  # 加载模型（包含模型对象、特征名等）
  artifacts <- readRDS("output/modeling_2.rds")
  model <- artifacts$model
  features <- artifacts$features
  class_levels <- artifacts$class_levels
  n_class <- artifacts$n_class
  
    
  observeEvent(input$goButton, {
    updateTabsetPanel(session, "mainTabs", selected = "Results")
  })
  
  # 构造预测函数
  get_prediction <- eventReactive(input$goButton, {
      # 收集输入数据
      input_values <- list(
        cps21_age             = input$q1,
        cps21_bornin_canada   = input$q2,
        pes21_province        = input$q3,
        cps21_marital         = input$q4,
        pes21_govtcare        = input$q5,
        cps21_fed_gov_sat     = input$q6,
        pes21_equalrights     = input$q7,
        pes21_donerm          = input$q8,
        pes21_abort2          = input$q9,
        pes21_famvalues       = input$q10,
        pes21_bilingualism    = input$q11,
        pes21_newerlife       = input$q12,
        pes21_fitin           = input$q13,
        pes21_immigjobs       = input$q14,
        pes21_inequal         = input$q15,
        pes21_privjobs        = input$q16,
        pes21_envirojob       = input$q17
      )
      
      # 转为 data.frame，列名顺序要和模型一致
      df <- as.data.frame(input_values)[features]
      levels_list <- artifacts$levels_list
      
      for (col in names(levels_list)) {
        if (col %in% names(df) && col != "cps21_age") {
          df[[col]] <- factor(df[[col]], levels = levels_list[[col]])
        }
      }
      for (col in names(df)) {
        if (col != "cps21_age" && is.factor(df[[col]])) {
          df[[col]] <- as.numeric(df[[col]])
        }
      }
      #str(df)
      
      # 转为 matrix 输入 XGBoost
      pred <- predict(model, as.matrix(df))

      # 做预测（softprob 输出每类的概率）
      #pred <- predict(model, as.matrix(df))
      pred_mat <- matrix(pred, ncol = n_class, byrow = TRUE)
      
      # 排序后显示概率
      pred_df <- data.frame(
        Party = class_levels,
        Probability = round(pred_mat[1, ], 4)
      )
      pred_df <- pred_df[order(-pred_df$Probability), ]
      
      return(pred_df)

  })

  # 输出预测表格
  output$pred <- renderTable({
    get_prediction()
  })
  
output$predPlot <- renderPlot({
  req(get_prediction())
  pred_df <- get_prediction()

  # 排序以便从高到低显示
  pred_df$Party <- factor(pred_df$Party, levels = pred_df$Party[order(pred_df$Probability)])

  ggplot(pred_df, aes(x = Party, y = Probability)) +
    geom_col(fill = "#4DAF4A", width = 0.6) +
    geom_text(aes(label = scales::percent(Probability, accuracy = 0.1)), 
              vjust = -0.5, size = 4) +
    ylim(0, 1) +
    labs(title = "Predicted Support Probability by Party",
         y = "Probability",
         x = "Party") +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
})

}
  
 

shinyApp(ui, server)
```
#### Version 2

```{r}
library(shiny)
library(shinydashboard)
library(ggplot2)

ui <- dashboardPage(
  dashboardHeader(title = "Voter Preference Prediction"),
  
  dashboardSidebar(
    sidebarMenu( id = "sidebarMenuID",
      menuItem("Form", tabName = "form", icon = icon("edit")),
      menuItem("Results", tabName = "results", icon = icon("chart-bar"))
    )
  ),
  
  dashboardBody(
    tabItems(
      tabItem(tabName = "form",
              fluidRow(
                box(
                  title = "Project Description", width = 12, status = "info", solidHeader = TRUE,
                  p("This project predicts the likelihood of a voter supporting each Canadian political party based on their responses to 16 questions. Select your answers below and click Predict to see probabilities.")
                ),
                box(
                  title = "Input", width = 12, status = "primary", solidHeader = TRUE,
                  do.call(tagList, all_inputs),
                  actionButton("goButton", "Predict")
                )
              )
      ),
      
      tabItem(tabName = "results",
              fluidRow(
                valueBoxOutput("predictedParty", width = 6),   # ✅ 新增摘要框
                valueBoxOutput("probability", width = 6)       # ✅ 新增摘要框
              ),
              fluidRow(
                box(title = "Prediction Table", width = 6, tableOutput("pred")),
                box(title = "Prediction Plot", width = 6, plotOutput("predPlot", height = "300px"))
              )
      )
    )
  )
)

server <- function(input, output, session) {
  # 加载模型（包含模型对象、特征名等）
  artifacts <- readRDS("output/modeling_2.rds")
  model <- artifacts$model
  features <- artifacts$features
  class_levels <- artifacts$class_levels
  n_class <- artifacts$n_class
  
  observeEvent(input$goButton, {
    updateTabItems(session, "sidebarMenuID", "results")  # ✅ 正确的函数
  })

  get_prediction <- eventReactive(input$goButton, {
    print("Predict button clicked!")  # ← Debug 用

    input_values <- list(
        cps21_age             = input$q1,
        cps21_bornin_canada   = input$q2,
        pes21_province        = input$q3,
        cps21_marital         = input$q4,
        pes21_govtcare        = input$q5,
        cps21_fed_gov_sat     = input$q6,
        pes21_equalrights     = input$q7,
        pes21_donerm          = input$q8,
        pes21_abort2          = input$q9,
        pes21_famvalues       = input$q10,
        pes21_bilingualism    = input$q11,
        pes21_newerlife       = input$q12,
        pes21_fitin           = input$q13,
        pes21_immigjobs       = input$q14,
        pes21_inequal         = input$q15,
        pes21_privjobs        = input$q16,
        pes21_envirojob       = input$q17
        )
    
    # 转为 data.frame，列名顺序要和模型一致
    df <- as.data.frame(input_values)[features]
    levels_list <- artifacts$levels_list
      
    for (col in names(levels_list)) {
      if (col %in% names(df) && col != "cps21_age") {
        df[[col]] <- factor(df[[col]], levels = levels_list[[col]])
      }
    }
    for (col in names(df)) {
      if (col != "cps21_age" && is.factor(df[[col]])) {
        df[[col]] <- as.numeric(df[[col]])
      }
    }
    
    pred <- predict(model, as.matrix(df))
    pred_mat <- matrix(pred, ncol = n_class, byrow = TRUE)

    pred_df <- data.frame(
      Party = class_levels,
      Probability = round(pred_mat[1, ], 4)
    )
    pred_df <- pred_df[order(-pred_df$Probability), ]

    return(pred_df)
  })

  # ✅ 结果输出
  output$pred <- renderTable({
    get_prediction()
  })

  output$predPlot <- renderPlot({
    req(get_prediction())
    pred_df <- get_prediction()
    pred_df$Party <- factor(pred_df$Party, levels = pred_df$Party[order(pred_df$Probability)])

    ggplot(pred_df, aes(x = Party, y = Probability)) +
      geom_col(fill = "#4DAF4A", width = 0.6) +
      geom_text(aes(label = scales::percent(Probability, accuracy = 0.1)), 
                vjust = -0.5, size = 4) +
      ylim(0, 1) +
      labs(title = "Predicted Support Probability by Party",
           y = "Probability",
           x = "Party") +
      theme_minimal(base_size = 14) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", hjust = 0.5)
      )
  })
}

```

```{r}
shinyApp(ui, server)
```



